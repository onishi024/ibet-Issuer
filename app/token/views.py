# -*- coding:utf-8 -*-
import secrets
import datetime
import json
from base64 import b64encode
from flask import Flask, request, redirect, url_for, flash, session
from flask_restful import Resource, Api
from flask import render_template
from flask import jsonify, abort
from flask_login import login_required, current_user
from flask import Markup, jsonify
from flask import current_app

from web3 import Web3
from solc import compile_source
from sqlalchemy import desc

from . import token
from .. import db
from ..models import Role, User, Token
from .forms import IssueTokenForm, TokenSettingForm
from ..decorators import admin_required
from config import Config

from logging import getLogger
logger = getLogger('api')

web3 = Web3(Web3.HTTPProvider('http://localhost:8545'))

#+++++++++++++++++++++++++++++++
# Utils
#+++++++++++++++++++++++++++++++
def flash_errors(form):
    for field, errors in form.errors.items():
        for error in errors:
            flash(error, 'error')

#+++++++++++++++++++++++++++++++
# Views
#+++++++++++++++++++++++++++++++
@token.route('/tokenlist', methods=['GET'])
@login_required
def list():
    logger.info('list')
    tokens = Token.query.all()
    token_list = []
    for row in tokens:
        if row.token_address != None:
            MyContract = web3.eth.contract(
                address=row.token_address,
                abi = json.loads(
                    row.abi.replace("'", '"').replace('True', 'true').replace('False', 'false')),
                bytecode = row.bytecode,
                bytecode_runtime = row.bytecode_runtime
            )
            name = MyContract.functions.name().call()
            symbol = MyContract.functions.symbol().call()
        else:
            name = '<処理中>'
            symbol = '<処理中>'
        token_list.append({
            'name':name,
            'symbol':symbol,
            'created':row.created,
            'tx_hash':row.tx_hash,
            'token_address':row.token_address
        })

    return render_template('token/list.html', tokens=token_list)


@token.route('/setting/<string:token_address>', methods=['GET', 'POST'])
@login_required
def setting(token_address):
    logger.info('token.token_address')
    token = Token.query.filter(Token.token_address==token_address).first()
    token_abi = json.loads(token.abi.replace("'", '"').replace('True', 'true').replace('False', 'false'))

    TokenContract = web3.eth.contract(
        address= token.token_address,
        abi = token_abi,
        bytecode = token.bytecode,
        bytecode_runtime = token.bytecode_runtime
    )

    name = TokenContract.functions.name().call()
    total_supply = TokenContract.functions.totalSupply().call()
    symbol = TokenContract.functions.symbol().call()

    form = TokenSettingForm()
    if request.method == 'POST':
        pass
    else: # GET
        form.token_address.data = token.token_address
        form.token_name.data = name
        form.total_supply.data = total_supply
        form.token_symbol.data = symbol
        form.image_small.data = None
        form.image_medium.data = None
        form.image_large.data = None
        form.abi.data = token.abi
        form.bytecode.data = token.bytecode
        return render_template('token/setting.html', form=form)


@token.route('/release', methods=['POST'])
@login_required
def release():
    token_address = request.form.get('token_address')

    list_contract_address = '0xf3031Fa79D36c51EbA5040C6c6634f529dD28EEc'

    list_contract_abi = json.loads('[{"constant": true,"inputs": [{"name": "_num","type": "uint256"}],"name": "getToken","outputs": [{"name": "token_address","type": "address"},{"name": "token_template","type": "string"},{"name": "owner_address","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"name": "_token_address","type": "address"}],"name": "getOwnerAddress","outputs": [{"name": "issuer_address","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [],"name": "getListLength","outputs": [{"name": "length","type": "uint256"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [{"name": "_token_address","type": "address"},{"name": "_new_owner_address","type": "address"}],"name": "changeOwner","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": false,"inputs": [{"name": "_token_address","type": "address"},{"name": "_token_template","type": "string"}],"name": "register","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"}]')

    list_contract_bytecode = '6060604052341561000f57600080fd5b610b448061001e6000396000f30060606040526004361061006d576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806332434a2e1461007257806391657049146100ee578063b65c531b14610167578063e4b50cb814610190578063f00d4b5d14610292575b600080fd5b341561007d57600080fd5b6100ec600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506102ea565b005b34156100f957600080fd5b610125600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190505061050d565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561017257600080fd5b61017a610575565b6040518082815260200191505060405180910390f35b341561019b57600080fd5b6101b16004808035906020019091905050610582565b604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001828103825284818151815260200191508051906020019080838360005b8381101561025557808201518184015260208101905061023a565b50505050905090810190601f1680156102825780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b341561029d57600080fd5b6102e8600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506106d6565b005b60008060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614151561036d57600080fd5b336000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600180548060010182816103fe9190610968565b916000526020600020906003020160006060604051908101604052808673ffffffffffffffffffffffffffffffffffffffff1681526020018581526020013373ffffffffffffffffffffffffffffffffffffffff16815250909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010190805190602001906104be92919061099a565b5060408201518160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050505050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b6000600180549050905090565b600061058c610a1a565b600060018481548110151561059d57fe5b906000526020600020906003020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1692506001848154811015156105e057fe5b90600052602060002090600302016001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106855780601f1061065a57610100808354040283529160200191610685565b820191906000526020600020905b81548152906001019060200180831161066857829003601f168201915b5050505050915060018481548110151561069b57fe5b906000526020600020906003020160020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690509193909250565b6000806000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415151561075b57600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415156107f357600080fd5b816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600090505b600180549050811015610963578273ffffffffffffffffffffffffffffffffffffffff166001828154811015156108a857fe5b906000526020600020906003020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610956578160018281548110151561090657fe5b906000526020600020906003020160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b8080600101915050610875565b505050565b815481835581811511610995576003028160030283600052602060002091820191016109949190610a2e565b5b505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106109db57805160ff1916838001178555610a09565b82800160010185558215610a09579182015b82811115610a085782518255916020019190600101906109ed565b5b509050610a169190610aab565b5090565b602060405190810160405280600081525090565b610aa891905b80821115610aa457600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000610a749190610ad0565b6002820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905550600301610a34565b5090565b90565b610acd91905b80821115610ac9576000816000905550600101610ab1565b5090565b90565b50805460018160011615610100020316600290046000825580601f10610af65750610b15565b601f016020900490600052602060002090810190610b149190610aab565b5b505600a165627a7a7230582043d76d14103fb01a85df4da8e3c8a793e06dc483e1ed484457deb928f2dc61190029'

    list_contract_bytecode_runtime = '60606040526004361061006d576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806332434a2e1461007257806391657049146100ee578063b65c531b14610167578063e4b50cb814610190578063f00d4b5d14610292575b600080fd5b341561007d57600080fd5b6100ec600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506102ea565b005b34156100f957600080fd5b610125600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190505061050d565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561017257600080fd5b61017a610575565b6040518082815260200191505060405180910390f35b341561019b57600080fd5b6101b16004808035906020019091905050610582565b604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001828103825284818151815260200191508051906020019080838360005b8381101561025557808201518184015260208101905061023a565b50505050905090810190601f1680156102825780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b341561029d57600080fd5b6102e8600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506106d6565b005b60008060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614151561036d57600080fd5b336000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600180548060010182816103fe9190610968565b916000526020600020906003020160006060604051908101604052808673ffffffffffffffffffffffffffffffffffffffff1681526020018581526020013373ffffffffffffffffffffffffffffffffffffffff16815250909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010190805190602001906104be92919061099a565b5060408201518160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050505050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b6000600180549050905090565b600061058c610a1a565b600060018481548110151561059d57fe5b906000526020600020906003020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1692506001848154811015156105e057fe5b90600052602060002090600302016001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106855780601f1061065a57610100808354040283529160200191610685565b820191906000526020600020905b81548152906001019060200180831161066857829003601f168201915b5050505050915060018481548110151561069b57fe5b906000526020600020906003020160020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690509193909250565b6000806000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415151561075b57600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415156107f357600080fd5b816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600090505b600180549050811015610963578273ffffffffffffffffffffffffffffffffffffffff166001828154811015156108a857fe5b906000526020600020906003020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610956578160018281548110151561090657fe5b906000526020600020906003020160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b8080600101915050610875565b505050565b815481835581811511610995576003028160030283600052602060002091820191016109949190610a2e565b5b505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106109db57805160ff1916838001178555610a09565b82800160010185558215610a09579182015b82811115610a085782518255916020019190600101906109ed565b5b509050610a169190610aab565b5090565b602060405190810160405280600081525090565b610aa891905b80821115610aa457600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000610a749190610ad0565b6002820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905550600301610a34565b5090565b90565b610acd91905b80821115610ac9576000816000905550600101610ab1565b5090565b90565b50805460018160011615610100020316600290046000825580601f10610af65750610b15565b601f016020900490600052602060002090810190610b149190610aab565b5b505600a165627a7a7230582043d76d14103fb01a85df4da8e3c8a793e06dc483e1ed484457deb928f2dc61190029'

    web3.personal.unlockAccount(web3.eth.accounts[0],"password",1000)

    ListContract = web3.eth.contract(
        address = list_contract_address,
        abi = list_contract_abi,
        bytecode = list_contract_bytecode,
        bytecode_runtime = list_contract_bytecode_runtime,
    )

    register_txid = ListContract.functions.register(token_address, 'IbetStraightBond').transact(
        {'from':web3.eth.accounts[0], 'gas':3000000}
    )

    flash('公開中です。公開開始までに数分程かかることがあります。', 'success')
    return redirect(url_for('.setting', token_address=token_address))


@token.route('/issue', methods=['GET', 'POST'])
@login_required
def issue():
    logger.info('issue')
    form = IssueTokenForm()
    if request.method == 'POST':
        if form.validate():
            web3.personal.unlockAccount(web3.eth.accounts[0],"password",1000)

            # for IbetStraightBond
            abi = json.loads('[{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"signatures","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"redemptionDate","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"redemptionAmount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"purpose","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"productType","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"num_holders","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_signer","type":"address"}],"name":"isSigned","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"interestRate","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"interestPaymentDate2","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"interestPaymentDate1","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"holders","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"holderAt","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"faceValue","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"balances","outputs":[{"name":"balance","type":"uint256"},{"name":"isValue","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"address"}],"name":"allowed","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"_name","type":"string"},{"name":"_symbol","type":"string"},{"name":"_totalSupply","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"previousOwner","type":"address"},{"indexed":true,"name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[],"name":"Redeem","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"signer","type":"address"}],"name":"Sign","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"signer","type":"address"}],"name":"Unsign","type":"event"},{"constant":false,"inputs":[],"name":"redeem","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"}],"name":"requestSignature","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"sign","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"unsign","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"}]')

            bytecode = '606060405234156200001057600080fd5b6040516200170c3803806200170c83398101604052808051820191906020018051820191906020018051906020019091905050336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555033600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508260029080519060200190620000dc92919062000194565b508160039080519060200190620000f592919062000194565b5080600481905550600454600f6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001819055506001600d819055506000600560006101000a81548160ff02191690831515021790555050505062000243565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620001d757805160ff191683800117855562000208565b8280016001018555821562000208579182015b8281111562000207578251825591602001919060010190620001ea565b5b5090506200021791906200021b565b5090565b6200024091905b808211156200023c57600081600090555060010162000222565b5090565b90565b6114b980620002536000396000f30060606040526004361061015f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806302433d0f1461016457806306fdde031461018d5780630e2774b41461021b57806318160ddd14610244578063197bc3361461026d57806327e235e3146102d05780632a11ced0146103285780632ca151221461038b578063313ce567146103b857806341e60c86146103e157806344fd9caa1461040e5780635c6581651461043d5780636121c61d146104a95780636666e49c146104d857806370740aab1461050157806370a082311461058f5780637c3a00fd146105dc5780638da5cb5b1461060b57806391cda5d01461066057806395d89b41146106b3578063a9059cbb14610741578063ab8f67c81461079b578063be040fb0146107ec578063c792f36d14610801578063cfb4a2cb14610854578063d9c6da7b1461087d578063f2fde38b146108a6575b600080fd5b341561016f57600080fd5b6101776108df565b6040518082815260200191505060405180910390f35b341561019857600080fd5b6101a06108e5565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156101e05780820151818401526020810190506101c5565b50505050905090810190601f16801561020d5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561022657600080fd5b61022e610983565b6040518082815260200191505060405180910390f35b341561024f57600080fd5b610257610989565b6040518082815260200191505060405180910390f35b341561027857600080fd5b61028e600480803590602001909190505061098f565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156102db57600080fd5b610307600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506109cc565b60405180838152602001821515151581526020019250505060405180910390f35b341561033357600080fd5b61034960048080359060200190919050506109fd565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561039657600080fd5b61039e610a30565b604051808215151515815260200191505060405180910390f35b34156103c357600080fd5b6103cb610b53565b6040518082815260200191505060405180910390f35b34156103ec57600080fd5b6103f4610b58565b604051808215151515815260200191505060405180910390f35b341561041957600080fd5b610421610c7b565b604051808260ff1660ff16815260200191505060405180910390f35b341561044857600080fd5b610493600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610c8e565b6040518082815260200191505060405180910390f35b34156104b457600080fd5b6104bc610cb3565b604051808260ff1660ff16815260200191505060405180910390f35b34156104e357600080fd5b6104eb610cc6565b6040518082815260200191505060405180910390f35b341561050c57600080fd5b610514610ccc565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610554578082015181840152602081019050610539565b50505050905090810190601f1680156105815780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561059a57600080fd5b6105c6600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610d6a565b6040518082815260200191505060405180910390f35b34156105e757600080fd5b6105ef610db6565b604051808260ff1660ff16815260200191505060405180910390f35b341561061657600080fd5b61061e610dc9565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561066b57600080fd5b610697600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610def565b604051808260ff1660ff16815260200191505060405180910390f35b34156106be57600080fd5b6106c6610e45565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156107065780820151818401526020810190506106eb565b50505050905090810190601f1680156107335780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561074c57600080fd5b610781600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035906020019091905050610ee3565b604051808215151515815260200191505060405180910390f35b34156107a657600080fd5b6107d2600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506111cd565b604051808215151515815260200191505060405180910390f35b34156107f757600080fd5b6107ff611231565b005b341561080c57600080fd5b610838600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506112d5565b604051808260ff1660ff16815260200191505060405180910390f35b341561085f57600080fd5b6108676112f5565b6040518082815260200191505060405180910390f35b341561088857600080fd5b6108906112fb565b6040518082815260200191505060405180910390f35b34156108b157600080fd5b6108dd600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050611301565b005b600d5481565b60028054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561097b5780601f106109505761010080835404028352916020019161097b565b820191906000526020600020905b81548152906001019060200180831161095e57829003601f168201915b505050505081565b60095481565b60045481565b6000600e600083815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b600f6020528060005260406000206000915090508060000154908060010160009054906101000a900460ff16905082565b600e6020528060005260406000206000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60006001601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1660ff16141515610a9057600080fd5b6002601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908360ff1602179055507ff5f1a1247aa8d2a5ca47f8c104886e2df9ac31612408cd09314472006efafa9b33604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a16001905090565b600081565b60006002601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1660ff16141515610bb857600080fd5b6000601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908360ff1602179055507f4139c849e3930f028ed84a97cbc49a0b2e17ce431020ce97f4d5b4c74ab3d34933604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a16001905090565b600560029054906101000a900460ff1681565b6011602052816000526040600020602052806000526040600020600091509150505481565b600560019054906101000a900460ff1681565b60085481565b600a8054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d625780601f10610d3757610100808354040283529160200191610d62565b820191906000526020600020905b815481529060010190602001808311610d4557829003601f168201915b505050505081565b6000600f60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001549050919050565b600560039054906101000a900460ff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000601060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff169050919050565b60038054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610edb5780601f10610eb057610100808354040283529160200191610edb565b820191906000526020600020905b815481529060010190602001808311610ebe57829003601f168201915b505050505081565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614151515610f2057600080fd5b600f60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001548211151515610f7157600080fd5b610fc682600f60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015461145690919063ffffffff16565b600f60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018190555061106182600f60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015461146f90919063ffffffff16565b600f60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000181905550600f60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900460ff16151561115e5782600e6000600d54815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506001600d5401600d819055505b8273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040518082815260200191505060405180910390a36001905092915050565b60006001601060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908360ff16021790555060019050919050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561128c57600080fd5b6001600560006101000a81548160ff0219169083151502179055507fd95402e764607b7b568a855d3414c03561cb940c03bb4d4ee47ea289e4f96a4260405160405180910390a1565b60106020528060005260406000206000915054906101000a900460ff1681565b60065481565b60075481565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561135c57600080fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415151561139857600080fd5b8073ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600082821115151561146457fe5b818303905092915050565b600080828401905083811015151561148357fe5b80915050929150505600a165627a7a723058208282c0b2b9ba78e1b7e32f212e3840307893d68450aacc3d167235e9ff79ed110029'

            bytecode_runtime = '60606040526004361061015f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806302433d0f1461016457806306fdde031461018d5780630e2774b41461021b57806318160ddd14610244578063197bc3361461026d57806327e235e3146102d05780632a11ced0146103285780632ca151221461038b578063313ce567146103b857806341e60c86146103e157806344fd9caa1461040e5780635c6581651461043d5780636121c61d146104a95780636666e49c146104d857806370740aab1461050157806370a082311461058f5780637c3a00fd146105dc5780638da5cb5b1461060b57806391cda5d01461066057806395d89b41146106b3578063a9059cbb14610741578063ab8f67c81461079b578063be040fb0146107ec578063c792f36d14610801578063cfb4a2cb14610854578063d9c6da7b1461087d578063f2fde38b146108a6575b600080fd5b341561016f57600080fd5b6101776108df565b6040518082815260200191505060405180910390f35b341561019857600080fd5b6101a06108e5565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156101e05780820151818401526020810190506101c5565b50505050905090810190601f16801561020d5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561022657600080fd5b61022e610983565b6040518082815260200191505060405180910390f35b341561024f57600080fd5b610257610989565b6040518082815260200191505060405180910390f35b341561027857600080fd5b61028e600480803590602001909190505061098f565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156102db57600080fd5b610307600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506109cc565b60405180838152602001821515151581526020019250505060405180910390f35b341561033357600080fd5b61034960048080359060200190919050506109fd565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561039657600080fd5b61039e610a30565b604051808215151515815260200191505060405180910390f35b34156103c357600080fd5b6103cb610b53565b6040518082815260200191505060405180910390f35b34156103ec57600080fd5b6103f4610b58565b604051808215151515815260200191505060405180910390f35b341561041957600080fd5b610421610c7b565b604051808260ff1660ff16815260200191505060405180910390f35b341561044857600080fd5b610493600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610c8e565b6040518082815260200191505060405180910390f35b34156104b457600080fd5b6104bc610cb3565b604051808260ff1660ff16815260200191505060405180910390f35b34156104e357600080fd5b6104eb610cc6565b6040518082815260200191505060405180910390f35b341561050c57600080fd5b610514610ccc565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610554578082015181840152602081019050610539565b50505050905090810190601f1680156105815780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561059a57600080fd5b6105c6600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610d6a565b6040518082815260200191505060405180910390f35b34156105e757600080fd5b6105ef610db6565b604051808260ff1660ff16815260200191505060405180910390f35b341561061657600080fd5b61061e610dc9565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561066b57600080fd5b610697600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610def565b604051808260ff1660ff16815260200191505060405180910390f35b34156106be57600080fd5b6106c6610e45565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156107065780820151818401526020810190506106eb565b50505050905090810190601f1680156107335780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561074c57600080fd5b610781600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035906020019091905050610ee3565b604051808215151515815260200191505060405180910390f35b34156107a657600080fd5b6107d2600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506111cd565b604051808215151515815260200191505060405180910390f35b34156107f757600080fd5b6107ff611231565b005b341561080c57600080fd5b610838600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506112d5565b604051808260ff1660ff16815260200191505060405180910390f35b341561085f57600080fd5b6108676112f5565b6040518082815260200191505060405180910390f35b341561088857600080fd5b6108906112fb565b6040518082815260200191505060405180910390f35b34156108b157600080fd5b6108dd600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050611301565b005b600d5481565b60028054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561097b5780601f106109505761010080835404028352916020019161097b565b820191906000526020600020905b81548152906001019060200180831161095e57829003601f168201915b505050505081565b60095481565b60045481565b6000600e600083815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b600f6020528060005260406000206000915090508060000154908060010160009054906101000a900460ff16905082565b600e6020528060005260406000206000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60006001601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1660ff16141515610a9057600080fd5b6002601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908360ff1602179055507ff5f1a1247aa8d2a5ca47f8c104886e2df9ac31612408cd09314472006efafa9b33604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a16001905090565b600081565b60006002601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1660ff16141515610bb857600080fd5b6000601060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908360ff1602179055507f4139c849e3930f028ed84a97cbc49a0b2e17ce431020ce97f4d5b4c74ab3d34933604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a16001905090565b600560029054906101000a900460ff1681565b6011602052816000526040600020602052806000526040600020600091509150505481565b600560019054906101000a900460ff1681565b60085481565b600a8054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d625780601f10610d3757610100808354040283529160200191610d62565b820191906000526020600020905b815481529060010190602001808311610d4557829003601f168201915b505050505081565b6000600f60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001549050919050565b600560039054906101000a900460ff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000601060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff169050919050565b60038054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610edb5780601f10610eb057610100808354040283529160200191610edb565b820191906000526020600020905b815481529060010190602001808311610ebe57829003601f168201915b505050505081565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614151515610f2057600080fd5b600f60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001548211151515610f7157600080fd5b610fc682600f60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015461145690919063ffffffff16565b600f60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018190555061106182600f60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015461146f90919063ffffffff16565b600f60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000181905550600f60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900460ff16151561115e5782600e6000600d54815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506001600d5401600d819055505b8273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040518082815260200191505060405180910390a36001905092915050565b60006001601060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908360ff16021790555060019050919050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561128c57600080fd5b6001600560006101000a81548160ff0219169083151502179055507fd95402e764607b7b568a855d3414c03561cb940c03bb4d4ee47ea289e4f96a4260405160405180910390a1565b60106020528060005260406000206000915054906101000a900460ff1681565b60065481565b60075481565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561135c57600080fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415151561139857600080fd5b8073ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600082821115151561146457fe5b818303905092915050565b600080828401905083811015151561148357fe5b80915050929150505600a165627a7a723058208282c0b2b9ba78e1b7e32f212e3840307893d68450aacc3d167235e9ff79ed110029'

            TokenContract = web3.eth.contract(
                abi = abi,
                bytecode = bytecode,
                bytecode_runtime = bytecode_runtime,
            )

            print(abi)

            arguments = [
                form.token_name.data,
                form.token_symbol.data,
                form.total_supply.data
            ]

            tx_hash = TokenContract.deploy(
                transaction={'from':web3.eth.accounts[0], 'gas':5000000},
                args=arguments
            ).hex()

            token = Token()
            token.template_id = 1
            token.tx_hash = tx_hash
            token.admin_address = None
            token.token_address = None
            token.abi = str(abi)
            token.bytecode = bytecode
            token.bytecode_runtime = bytecode_runtime
            db.session.add(token)

            msg = Markup('新規発行を受け付けました。発行完了までに数分程かかることがあります。 受付ID：%s' % (tx_hash))
            flash(msg, 'confirm')
            return redirect(url_for('.list'))
        else:
            flash_errors(form)
            return render_template('token/issue.html', form=form)
    else: # GET
        return render_template('token/issue.html', form=form)


@token.route('/PermissionDenied', methods=['GET', 'POST'])
@login_required
def permissionDenied():
    return render_template('permissiondenied.html')

#+++++++++++++++++++++++++++++++
# Custom Filter
#+++++++++++++++++++++++++++++++
@token.app_template_filter()
def format_date(date): # date = datetime object.
    if date:
        if isinstance(date, datetime.datetime):
            return date.strftime('%Y/%m/%d %H:%M')
        elif isinstance(date, datetime.date):
            return date.strftime('%Y/%m/%d')
    return ''

@token.app_template_filter()
def img_convert(icon):
    if icon:
        img = b64encode(icon)
        return img.decode('utf8')
    return None
